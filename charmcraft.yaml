# This file configures Charmcraft.
# See https://juju.is/docs/sdk/charmcraft-config for guidance.

name: airbyte-k8s
type: charm
title: Airbyte Server
summary: Airbyte server operator
description: |
  Airbyte is an open-source data integration platform designed to centralize and 
  streamline the process of extracting and loading data from various sources into 
  data warehouses, lakes, or other destinations.

# (Required for 'charm' type)
bases:
  - build-on:
    - name: ubuntu
      channel: "22.04"
    run-on:
    - name: ubuntu
      channel: "22.04"


# Metadata
peers:
  peer:
    interface: airbyte

requires:
  db:
    interface: postgresql_client
    limit: 1

  object-storage:
    interface: object-storage
    schema:
      v1:
        provides:
          type: object
          properties:
            access-key:
              type: string
            namespace:
              type:
              - string
              - 'null'
            port:
              type: number
            secret-key:
              type: string
            secure:
              type: boolean
            service:
              type: string
          required:
          - access-key
          - port
          - secret-key
          - secure
          - service
    versions: [v1]
    __schema_source: https://raw.githubusercontent.com/canonical/operator-schemas/master/object-storage.yaml

  s3-parameters:
    interface: s3
    limit: 1
    optional: true

provides:
  airbyte-server:
    interface: airbyte-server
    optional: true
    limit: 1

# (Optional) Configuration options for the charm
# This config section defines charm config options, and populates the Configure
# tab on Charmhub.
# More information on this section at https://juju.is/docs/sdk/charmcraft-yaml#heading--config
# General configuration documentation: https://juju.is/docs/sdk/config
config:
  options:
    # An example config option to customise the log level of the workload
    log-level:
      description: |
        Configures the log level.

        Acceptable values are: "INFO", "DEBUG", "WARNING", "ERROR" and "FATAL"
      default: "INFO"
      type: string

    temporal-host:
      description: Temporal server host.
      default: "temporal-k8s:7233"
      type: string

    storage-type:
      description: |
        Storage type for logs.

        Acceptable values are: "MINIO", "S3" (AWS)
      default: "MINIO"
      type: string

    storage-bucket-logs:
      description: Name of logs storage bucket.
      default: "airbyte-dev-logs"
      type: string

    logs-ttl:
      description: |
        Number of days until logs are purged from object storage.
      default: 30
      type: int

    storage-bucket-state:
      description: Name of state storage bucket.
      default: "airbyte-state-storage"
      type: string

    storage-bucket-activity-payload:
      description: Name of activity payload storage bucket.
      default: "airbyte-payload-storage"
      type: string

    storage-bucket-workload-output:
      description: Name of workload output storage bucket.
      default: "airbyte-state-storage"
      type: string

    pod-running-ttl-minutes:
      description: Number of minutes until a running job pod is removed.
      default: 240
      type: int

    pod-successful-ttl-minutes:
      description: Number of minutes until a successful job pod is removed.
      default: 30
      type: int

    pod-unsuccessful-ttl-minutes:
      description: Number of minutes until an unsuccessful job pod is removed.
      default: 1440
      type: int

# The containers and resources metadata apply to Kubernetes charms only.
# See https://juju.is/docs/sdk/metadata-reference for a checklist and guidance.

# Your workloadâ€™s containers.
containers:
  airbyte-api-server:
    resource: airbyte-api-server
  airbyte-bootloader:
    resource: airbyte-bootloader
  airbyte-connector-builder-server:
    resource: airbyte-connector-builder-server
  airbyte-cron:
    resource: airbyte-cron
  airbyte-pod-sweeper:
    resource: airbyte-pod-sweeper
  airbyte-server:
    resource: airbyte-server
  airbyte-workers:
    resource: airbyte-workers

# This field populates the Resources tab on Charmhub.
resources:
  airbyte-api-server:
    type: oci-image
    description: OCI image for Airbyte API server
    upstream-source: airbyte/airbyte-api-server:0.60.0
  airbyte-bootloader:
    type: oci-image
    description: OCI image for Airbyte Bootloader
    upstream-source: airbyte/bootloader:0.60.0
  airbyte-connector-builder-server:
    type: oci-image
    description: OCI image for Airbyte Connector Builder Server
    upstream-source: airbyte/connector-builder-server:0.60.0
  airbyte-cron:
    type: oci-image
    description: OCI image for Airbyte Cron
    upstream-source: airbyte/cron:0.60.0
  airbyte-pod-sweeper:
    type: oci-image
    description: OCI image for Airbyte Pod Sweeper
    upstream-source: bitnami/kubectl:1.29.4
  airbyte-server:
    type: oci-image
    description: OCI image for Airbyte Server
    upstream-source: airbyte/server:0.60.0
  airbyte-workers:
    type: oci-image
    description: OCI image for Airbyte Worker
    upstream-source: airbyte/worker:0.60.0
