# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: airbyte
summary: Airbyte rock
description: Airbyte OCI image for the Airbyte charm
version: "1.7.0"
base: ubuntu@22.04
license: Apache-2.0
platforms:
  # amd64:
  arm64:

environment:
  # JAVA_HOME: /usr/lib/jvm/java-21-openjdk-amd64
  # JAVA_HOME: /usr/lib/jvm/java-21-openjdk-arm64
  CDK_PYTHON: /usr/bin/python3.10
  CDK_ENTRYPOINT: /usr/lib/python3.10/dist-packages/airbyte_cdk/connector_builder/main.py
  CDK_VERSION: "5.12.0"
  JAVA_HOME: /usr/lib/jvm/default-java
  PATH: "/usr/lib/jvm/default-java/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"


parts:
  install-dependencies:
    plugin: nil
    stage-packages:
      - apt-transport-https
      - ca-certificates
      - curl 
      - gnupg
      - python3-pip
      - python3.10-venv  
    override-build: |
      # Install kubectl
      echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
      chmod 644 /etc/apt/sources.list.d/kubernetes.list   # helps tools such as command-not-found to work correctly
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg # allow unprivileged APT programs to read this keyring
      apt-get update
      apt-get install -y kubectl
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/bin
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/lib/python3.10/dist-packages
      cp -r $(which kubectl) ${CRAFT_PART_INSTALL}/usr/local/bin/kubectl

        # Use python3.10 -m pip explicitly to avoid PATH issues
        /usr/bin/python3.10 -m pip install --upgrade setuptools pip airbyte-cdk==5.12.0 \
          --target=${CRAFT_PART_INSTALL}/usr/local/lib/python3.10/dist-packages
    stage:
      - usr/local/bin/kubectl
      - usr/local/lib/python3.10/dist-packages

  pull-airbyte-repo:
    after: [install-dependencies]
    plugin: dump
    source: https://github.com/airbytehq/airbyte-platform.git # yamllint disable-line
    source-type: git
    source-tag: v1.7.0
    override-build: |
      cp -r . ${CRAFT_PART_INSTALL}/airbyte-platform
    stage:
      - airbyte-platform

  assemble:
    after: [pull-airbyte-repo]
    plugin: nil
    build-packages:
      - jq
      - curl
      - coreutils
      - bash
      - gradle
      - openjdk-21-jdk-headless
      - npm
      - libpq-dev
      - python3-dev
    build-snaps:
      - docker
    stage-packages:
      - openjdk-21-jdk-headless
      - libpq-dev
      - python3-dev
    override-build: |
      cd ${CRAFT_STAGE}/airbyte-platform
      # Create a stable JAVA_HOME symlink for runtime: /usr/lib/jvm/default-java
      ARCH=$(dpkg --print-architecture)
      if [ "$ARCH" = "arm64" ]; then
        REAL_JAVA_HOME=/usr/lib/jvm/java-21-openjdk-arm64
      else
        REAL_JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
      fi
      ln -sf "$REAL_JAVA_HOME" /usr/lib/jvm/default-java
      export JAVA_HOME=/usr/lib/jvm/default-java
      export PATH="$JAVA_HOME/bin:$PATH"
      ./gradlew assemble -x dockerBuildImage --continue --max-workers 1
      ./gradlew --stop

  organize-tars:
    after: [assemble]
    plugin: nil
    override-build: |
      mkdir ${CRAFT_PART_INSTALL}/airbyte-server
      mkdir ${CRAFT_PART_INSTALL}/airbyte-workers
      mkdir ${CRAFT_PART_INSTALL}/airbyte-bootloader
      mkdir ${CRAFT_PART_INSTALL}/airbyte-cron
      mkdir ${CRAFT_PART_INSTALL}/airbyte-connector-builder-server
      mkdir ${CRAFT_PART_INSTALL}/airbyte-workload-api-server
      mkdir ${CRAFT_PART_INSTALL}/airbyte-workload-launcher

      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-server/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-server
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-workers/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-workers
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-bootloader/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-bootloader
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-cron/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-cron
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-connector-builder-server/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-connector-builder-server
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-workload-api-server/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-workload-api-server
      tar -xvf ${CRAFT_STAGE}/airbyte-platform/airbyte-workload-launcher/build/distributions/airbyte-app.tar -C ${CRAFT_PART_INSTALL}/airbyte-workload-launcher

      # Fix CVE-2025-59340 by replacing jinjava 2.7.4 with 2.7.5
      JINJAVA_VERSION="2.7.5"
      JINJAVA_BASE_URL="https://repo1.maven.org/maven2/com/hubspot/jinjava/jinjava"
      
      # Find and replace jinjava JAR files
      find ${CRAFT_PART_INSTALL} -name "jinjava-2.7.4.jar" -type f | while read -r jar_file; do
        jar_dir=$(dirname "$jar_file")
        echo "Replacing jinjava in: $jar_file"
        curl -L ${JINJAVA_BASE_URL}/${JINJAVA_VERSION}/jinjava-${JINJAVA_VERSION}.jar \
          -o "${jar_dir}/jinjava-${JINJAVA_VERSION}.jar"
        rm -f "$jar_file"
      done
    stage:
      - airbyte-server
      - airbyte-workers
      - airbyte-bootloader
      - airbyte-cron
      - airbyte-connector-builder-server
      - airbyte-workload-api-server
      - airbyte-workload-launcher

  local-files:
    after: [organize-tars]
    plugin: dump
    source: ./local-files
    organize:
      pod-sweeper.sh: airbyte-pod-sweeper/airbyte-app/bin/airbyte-pod-sweeper
    stage:
      - airbyte-pod-sweeper/airbyte-app/bin/airbyte-pod-sweeper
